<!DOCTYPE html>
<html>
<head>
  <title>Equalizer</title>
  <link rel=stylesheet href="style.css">
</head>
<body>
  <div>
    <div id="player-info" class="info">paused</div>
    <button id="btn-play">Play</button>
    <button id="btn-pause">Pause</button>
  </div>
  <script>
    (function equalizer(window){
      'use strict';

      const context = new AudioContext();
      let playerInfo = document.getElementById('player-info');
      let source;

      function loadAudioFile(url){
        let promise = new Promise((resolve, reject) => {
          let request = new XMLHttpRequest();

          request.open('GET', url, true);
          request.responseType = 'arraybuffer';

          request.onload = () => {
            let response = request.response;
            if (response.byteLength){
              // This will decode the AudioBuffer passed to the resolve
              context.decodeAudioData(request.response, resolve);
            }
            else {
              reject('Cannot load file at url: ' + url);
            }
          };

          request.onerror = reject;

          request.send();
        });

        return promise;
      }

      function play(fileSrc){
        loadAudioFile(fileSrc).then(
          (buffer) => {
            source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(context.destination);
            source.start(0);

            let fileName = fileSrc.substr(fileSrc.lastIndexOf('/') + 1);
            let duration = (buffer.duration / 60).toFixed(2);
            playerInfo.innerText = `playing ${fileName} - (${duration})`;
          },
          (reason) => {
            playerInfo.innerText = 'load error!';
            console.error('File load failed!', reason);
          });
      }

      document.getElementById('btn-play').addEventListener('click', () => {
        playerInfo.innerText = 'loading...';
        play('/sounds/01 - Bob Marley - Sun is shining.mp3');
      });

      document.getElementById('btn-pause').addEventListener('click', () => {
        playerInfo.innerText = 'paused';
        source.disconnect();
      });

    }(window));
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Equalizer</title>
  <link rel=stylesheet href="style.css">
</head>
<body>
  <div>
    <div id="player-info" class="info">paused</div>
    <div id="track-info" class="info"></div>
    <button id="btn-play">Play</button>
    <button id="btn-pause">Pause</button>
  </div>
  <script>
    (function equalizer(window){
      'use strict';

      const context = new AudioContext();
      const byId = function byId(id) {
        let cache = byId.cache || {};

        if (cache.hasOwnProperty(id)){
          return cache[id];
        }

        let el = document.getElementById(id);

        el.on = function (event, handler) {
          this.addEventListener(event, handler, false);
        }.bind(el);

        el.text = function (text = '') {
          this.innerText = text;
        }.bind(el);

        byId.cache = cache[id] = el;

        return el;
      };
      let playerInfo = (info) => {
        byId('player-info').text(info);
      };
      let trackInfo = (info) => {
        byId('track-info').text(info);
      };
      let source;

      function loadAudioFile(url){
        let promise = new Promise((resolve, reject) => {
          let request = new XMLHttpRequest();

          request.open('GET', url, true);
          request.responseType = 'arraybuffer';

          request.onload = () => {
            let response = request.response;
            if (response.byteLength){
              // This will decode the AudioBuffer passed to the resolve
              context.decodeAudioData(request.response, resolve);
            }
            else {
              reject('Cannot load file at url: ' + url);
            }
          };

          request.onerror = reject;

          request.send();
        });

        return promise;
      }

      function play(fileSrc){
        loadAudioFile(fileSrc).then(
          (buffer) => {
            source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(context.destination);
            source.start(0);

            playerInfo('playing');
            let fileName = fileSrc.substr(fileSrc.lastIndexOf('/') + 1);
            let duration = (buffer.duration / 60).toFixed(2);
            trackInfo(`${fileName} - (${duration})`);
          },
          (reason) => {
            playerInfo('load error!');
            trackInfo();
            console.error('File load failed!', reason);
          });
      }

      byId('btn-play').on('click', () => {
        playerInfo('loading...');
        play('/sounds/01 - Bob Marley - Sun is shining.mp3');
      });

      byId('btn-pause').on('click', () => {
        trackInfo();
        playerInfo('paused');
        source.disconnect();
      });

    }(window));
  </script>
</body>
</html>
